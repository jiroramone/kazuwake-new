<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>かずわけゲーム</title>
    <!-- Tone.jsとTailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #fff8e1; /* 背景色をクリーム色に変更 */
            color: #2d3748;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh; /* 画面の高さを超えた場合にスクロール可能に */
            overflow-x: hidden; /* 横スクロールを無効化 */
            position: relative;
            padding: 1rem;
            box-sizing: border-box;
        }

        #game-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        #title-screen {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: #fff8e1; /* 背景をクリーム色に変更 */
            padding: 2.5rem;
            border-radius: 1rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            z-index: 10;
        }

        /* タイトル画面のテキスト色を黒に変更 */
        #title-screen h1, #title-screen p {
            color: #2d3748;
        }

        #game-screen {
            display: none; /* Initially hidden */
            width: 100%;
            justify-content: center; /* 画面を中央に配置 */
            align-items: center; /* 画面を中央に配置 */
        }

        .game-elements-container {
            position: relative;
            width: 90%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 20px; /* 全体的な要素の間隔を調整 */
            margin-top: 0;
        }

        /* 問題文の背景を黒板風に */
        #problem-container {
            background-color: #2c523f; /* Dark green for chalkboard effect */
            border: 10px solid #5a4638; /* Wood frame */
            border-radius: 10px;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            width: 60%;
            max-width: 500px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        #problem-question {
            font-size: 1.5rem;
            font-weight: bold;
            color: #e2e8f0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 0;
        }

        #problem-text {
            font-size: 3rem;
            font-weight: bold;
            color: #fed7aa; /* Chalk-like color */
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            transition: opacity 0.75s ease-in-out;
            margin: 0;
        }
        
        #problem-text.fade-out {
            opacity: 0;
        }
        
        #problem-text.fade-in {
            opacity: 1;
        }

        #lamps-container {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 1rem;
        }

        .lamp {
            width: 25px;
            height: 25px;
            background-color: #a0aec0;
            border-radius: 50%;
            border: 2px solid #2d3748;
            box-shadow: inset 0 0 5px rgba(0, 0, 0, 0.3);
            transition: background-color 0.3s ease;
        }

        .lamp.lit {
            background-color: #f6ad55;
            box-shadow: 0 0 10px #f6ad55, inset 0 0 5px #f6ad55;
        }

        #marbles-area {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(45, 55, 72, 0.8);
            min-height: 50px;
            width: 100%;
            margin-bottom: 20px;
            margin-top: 10px;
        }

        .marble {
            width: 30px;
            height: 30px;
            background-color: #e53e3e;
            border-radius: 50%;
            cursor: grab;
            touch-action: none;
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        #split-area {
            display: flex;
            justify-content: center;
            gap: 30px;
            align-items: center;
            flex-direction: column;
            width: 100%;
        }

        .split-boxes {
            display: flex;
            justify-content: center;
            gap: 20px;
            width: 100%;
        }

        .plate-box {
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, #2d3748 0%, #4a5568 100%);
            border: 4px solid #718096;
            border-radius: 50%;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 5px;
            padding: 10px;
        }

        .plate-box.highlight {
            border-color: rgba(99, 179, 237, 0.5);
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5), 0 0 15px rgba(99, 179, 237, 0.5);
        }

        #timer {
            font-size: 1.5rem;
            color: #f56565;
            font-weight: bold;
            margin-bottom: 1rem;
        }

        .btn {
            background-color: #63b3ed;
            color: #fff;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease-in-out;
            border: none;
        }

        .btn:hover {
            background-color: #4299e1;
            transform: translateY(-2px);
            box-shadow: 0 6px 8px rgba(0, 0, 0, 0.15);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .button-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        #problem-text-and-button-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        #submit-btn {
            padding: 0.5rem 1rem;
            font-size: 1rem;
            margin: 0;
        }

        #message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(45, 55, 72, 0.95);
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
            text-align: center;
            z-index: 100;
            display: none;
        }
        
        /* スマートフォン向けスタイル */
        @media (max-width: 600px) {
            #problem-container {
                width: 80%; /* スマートフォンでは黒板を少し大きく */
                border-width: 5px;
            }
            #problem-question {
                font-size: 1.2rem;
            }
            #problem-text {
                font-size: 2.5rem;
            }
            #marbles-area {
                padding: 5px;
                gap: 5px;
            }
            .marble {
                width: 25px;
                height: 25px;
            }
            #split-area {
                gap: 10px; /* 皿の間の隙間を狭く */
            }
            .plate-box {
                width: 120px;
                height: 120px;
                border-width: 2px;
                padding: 5px;
            }
            #timer {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        
        <!-- タイトル画面 -->
        <div id="title-screen">
            <h1 class="text-4xl font-bold mb-6">かずわけゲーム</h1>
            <p class="mb-4">レベルを選んでね！</p>
            <div class="button-group">
                <button class="btn" onclick="startGame(1)">レベル1: 順番に出題</button>
                <button class="btn" onclick="startGame(2)">レベル2: ランダム出題</button>
                <button class="btn" onclick="startGame(3)">レベル3: 時間制限付き</button>
            </div>
        </div>

        <!-- ゲーム画面 -->
        <div id="game-screen" class="hidden">
            <div class="game-elements-container" id="game-elements-container">
                <div id="problem-container">
                    <div id="lamps-container"></div>
                    <p id="problem-question">いくつといくつにわけられる？</p>
                    <p id="problem-text">3</p>
                    <div id="marbles-area" ondrop="handleDrop(event)" ondragover="allowDrop(event)" ondragleave="handleDragLeave(event)"></div>
                </div>
    
                <div id="timer" class="hidden"></div>

                <!-- 皿のような分けるスペース -->
                <div id="split-area">
                    <div class="split-boxes">
                        <div id="split-left" class="plate-box" ondrop="handleDrop(event)" ondragover="allowDrop(event)" ondragleave="handleDragLeave(event)"></div>
                        <div id="split-right" class="plate-box" ondrop="handleDrop(event)" ondragover="allowDrop(event)" ondragleave="handleDragLeave(event)"></div>
                    </div>
                </div>
                <!-- できた！ボタンを皿の下に移動 -->
                <button id="submit-btn" class="btn mt-4" onclick="handleSubmit()">できた！</button>
            </div>
        </div>

        <!-- メッセージボックス -->
        <div id="message-box" class="hidden">
            <p id="message-text" class="text-xl font-bold"></p>
            <button id="message-close-btn" class="btn mt-4 w-full">OK</button>
        </div>
    </div>

    <script>
        // ゲームの状態を管理する変数
        let currentLevel = 0;
        let currentNumber = 0;
        let allCombinations = [];
        let foundCombinations = new Set();
        let currentTimer = null;
        const numbers = [3, 4, 5, 6, 7, 8, 9, 10];
        let problemQueue = [];
        let isAnimating = false; // アニメーション中かどうかを管理するフラグ
        let synth; // 効果音用のシンセサイザー

        // UI要素への参照
        const titleScreen = document.getElementById('title-screen');
        const gameScreen = document.getElementById('game-screen');
        const gameElementsContainer = document.getElementById('game-elements-container');
        const problemText = document.getElementById('problem-text');
        const lampsContainer = document.getElementById('lamps-container');
        const marblesArea = document.getElementById('marbles-area');
        const splitLeft = document.getElementById('split-left');
        const splitRight = document.getElementById('split-right');
        const submitBtn = document.getElementById('submit-btn');
        const timerDisplay = document.getElementById('timer');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const messageCloseBtn = document.getElementById('message-close-btn');

        // 効果音を初期化
        function initializeSound() {
            // Tone.jsを初期化
            synth = new Tone.Synth().toDestination();
        }

        // 正解音を再生する
        async function playCorrectSound() {
            // ブラウザの自動再生ポリシーに対応するため、ユーザーインタラクション後にTone.jsを起動
            await Tone.start();
            // ピンポンに似た音を出すための周波数と持続時間を設定
            synth.triggerAttackRelease("C5", "8n", "+0.01");
            synth.triggerAttackRelease("G5", "8n", "+0.15");
        }
        
        // 不正解音を再生する
        async function playIncorrectSound() {
            await Tone.start();
            synth.triggerAttackRelease("F#3", "8n");
        }

        // ドラッグアンドドロップ関連のイベントハンドラ
        let draggedMarble = null;
        let originalMarble = null;

        document.addEventListener('touchstart', (e) => {
            const marble = e.target.closest('.marble');
            if (marble) {
                originalMarble = marble;
                draggedMarble = marble.cloneNode(true);
                draggedMarble.style.position = 'absolute';
                draggedMarble.classList.add('opacity-50'); // ドラッグ中の見た目を変更
                document.body.appendChild(draggedMarble);
                originalMarble.style.visibility = 'hidden'; // 元のマーブルを非表示に
                
                const touch = e.touches[0];
                draggedMarble.style.left = `${touch.clientX - marble.offsetWidth / 2}px`;
                draggedMarble.style.top = `${touch.clientY - marble.offsetHeight / 2}px`;
            }
        });

        document.addEventListener('touchmove', (e) => {
            if (!draggedMarble) return;
            e.preventDefault(); // これを追加してデフォルトのタッチ動作を無効化
            const touch = e.touches[0];
            draggedMarble.style.left = `${touch.clientX - draggedMarble.offsetWidth / 2}px`;
            draggedMarble.style.top = `${touch.clientY - draggedMarble.offsetHeight / 2}px`;
        });

        document.addEventListener('touchend', (e) => {
            if (!draggedMarble) return;

            // ドロップ先の要素を正しく取得するために、一時的にクローンを非表示にする
            draggedMarble.style.display = 'none';
            const touch = e.changedTouches[0];
            const targetElement = document.elementFromPoint(touch.clientX, touch.clientY);
            // 非表示にしたクローンを元に戻す
            draggedMarble.style.display = 'block';

            const parentSplitBox = targetElement.closest('.plate-box');
            const marblesAreaElement = targetElement.closest('#marbles-area');

            // 元のマーブルを再表示する
            if (originalMarble) {
                originalMarble.style.visibility = 'visible';
            }
            
            if (parentSplitBox) {
                // ドロップ先に元のマーブルを移動
                parentSplitBox.appendChild(originalMarble);
            } else if (marblesAreaElement) {
                // 元のエリアに元のマーブルを移動
                marblesArea.appendChild(originalMarble);
            } else {
                 // どこにもドロップされなかった場合、元のエリアに戻す
                 marblesArea.appendChild(originalMarble);
            }

            // ドラッグ用のマーブルを削除
            draggedMarble.remove();
            draggedMarble = null;
            originalMarble = null;
        });

        function handleDragStart(e) {
            draggedMarble = e.target;
            setTimeout(() => e.target.classList.add('opacity-50'), 0);
        }

        function allowDrop(e) {
            e.preventDefault();
            const target = e.target.closest('.plate-box') || e.target.closest('#marbles-area');
            if (target) {
                target.classList.add('highlight');
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            const target = e.target.closest('.plate-box') || e.target.closest('#marbles-area');
            if (target) {
                target.appendChild(draggedMarble);
            } else {
                 // Drop outside, return to marbles area
                 marblesArea.appendChild(draggedMarble);
            }
            draggedMarble.classList.remove('opacity-50');
            draggedMarble = null;
            document.querySelectorAll('.plate-box, #marbles-area').forEach(box => box.classList.remove('highlight'));
        }

        function handleDragLeave(e) {
            e.preventDefault();
            const target = e.target.closest('.plate-box') || e.target.closest('#marbles-area');
            if (target) {
                target.classList.remove('highlight');
            }
        }

        function handleDragEnd(e) {
            e.target.classList.remove('opacity-50');
            document.querySelectorAll('.plate-box, #marbles-area').forEach(box => box.classList.remove('highlight'));
            draggedMarble = null;
        }

        // 全てのマーブルにドラッグイベントを追加
        function setupMarbles() {
            const marbles = document.querySelectorAll('.marble');
            marbles.forEach(marble => {
                marble.addEventListener('dragstart', handleDragStart);
                marble.addEventListener('dragend', handleDragEnd);
            });
        }
        
        // レベル選択とゲーム開始
        function startGame(level) {
            initializeSound(); // 効果音を初期化
            currentLevel = level;
            titleScreen.style.display = 'none';
            gameScreen.style.display = 'flex';
            
            if (currentLevel === 1) {
                problemQueue = [...numbers]; // 3-10まで順番
            } else if (currentLevel === 2) {
                problemQueue = shuffle([...numbers]); // ランダム
            } else if (currentLevel === 3) {
                problemQueue = shuffle([...numbers]); // ランダム＋タイマー
                timerDisplay.classList.remove('hidden');
            }
            loadNextProblem();
        }

        // 問題をシャッフルする関数
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 次の問題へのアニメーションと読み込み
        function handleNextProblemAnimation() {
            if (isAnimating) return;
            isAnimating = true;

            // 問題文だけをフェードアウト
            problemText.classList.add('fade-out');
            setTimeout(() => {
                loadNextProblem();
                // 問題文をフェードイン
                problemText.classList.remove('fade-out');
                problemText.classList.add('fade-in');
                setTimeout(() => {
                    problemText.classList.remove('fade-in');
                    isAnimating = false;
                }, 750);
            }, 750);
        }

        // 次の問題を読み込む
        function loadNextProblem() {
            if (problemQueue.length === 0) {
                // レベルクリア時の処理
                showModal('レベルクリア！', `レベル ${currentLevel} の問題をすべて解きました！`, returnToTitleScreen);
                return;
            }

            const nextNumber = problemQueue.shift();
            loadProblem(nextNumber);
        }

        // 問題を読み込む
        function loadProblem(number) {
            currentNumber = number;
            foundCombinations.clear();
            allCombinations = [];

            for (let i = 0; i <= number; i++) {
                allCombinations.push([i, number - i].sort().join(','));
            }
            allCombinations = [...new Set(allCombinations)];

            problemText.textContent = currentNumber;
            renderMarbles();
            renderLamps();
            resetSplitBoxes();

            if (currentLevel === 3) {
                startTimer();
            }
        }

        // マーブルをレンダリングする
        function renderMarbles() {
            marblesArea.innerHTML = '';
            for (let i = 0; i < currentNumber; i++) {
                const marble = document.createElement('div');
                marble.classList.add('marble');
                marble.draggable = true;
                marblesArea.appendChild(marble);
            }
            setupMarbles();
        }

        // ランプをレンダリングする
        function renderLamps() {
            lampsContainer.innerHTML = '';
            allCombinations.forEach(() => {
                const lamp = document.createElement('div');
                lamp.classList.add('lamp');
                lampsContainer.appendChild(lamp);
            });
        }

        // スプリットボックスをリセットする
        function resetSplitBoxes() {
            splitLeft.innerHTML = '';
            splitRight.innerHTML = '';
            marblesArea.innerHTML = '';
            renderMarbles();
        }

        // 決定ボタンの処理
        function handleSubmit() {
            const leftCount = splitLeft.children.length;
            const rightCount = splitRight.children.length;

            const currentCombination = [leftCount, rightCount].sort().join(',');

            if (foundCombinations.has(currentCombination)) {
                showModal('ヒント', 'この組み合わせはもう見つけているよ。');
                playIncorrectSound(); // 不正解音を再生
                resetSplitBoxes();
                return;
            }

            if (allCombinations.includes(currentCombination)) {
                foundCombinations.add(currentCombination);
                updateLamps();
                playCorrectSound(); // 正解音を再生
                
                // 全問正解したかチェック
                if (foundCombinations.size === allCombinations.length) {
                    if (currentLevel === 3) {
                        resetTimer();
                    }
                    // 全組み合わせ正解後、次の問題へ自動的に遷移
                    handleNextProblemAnimation();
                } else {
                    // 正解だが、まだ全問ではない
                    showModal('正解！', 'よくできたね！');
                    resetSplitBoxes();
                }
            } else {
                // 不正解
                showModal('残念！', 'この組み合わせは違うみたい。');
                playIncorrectSound(); // 不正解音を再生
                resetSplitBoxes();
            }
        }

        // ランプの状態を更新する
        function updateLamps() {
            const lamps = document.querySelectorAll('.lamp');
            let lampIndex = 0;
            allCombinations.forEach(comb => {
                if (foundCombinations.has(comb)) {
                    lamps[lampIndex].classList.add('lit');
                }
                lampIndex++;
            });
        }

        // モーダル（メッセージボックス）を表示する
        function showModal(title, text, callback = null) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
            // メッセージボックスを閉じたときにコールバックを実行
            messageCloseBtn.onclick = () => {
                messageBox.classList.add('hidden');
                if (callback) {
                    callback();
                }
            };
        }

        // レベル3のタイマー処理
        function startTimer() {
            resetTimer();
            let timeLeft = 20;
            timerDisplay.textContent = `残り時間: ${timeLeft}秒`;
            submitBtn.disabled = false;

            currentTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `残り時間: ${timeLeft}秒`;

                if (timeLeft <= 0) {
                    clearInterval(currentTimer);
                    submitBtn.disabled = true;
                    showModal('時間切れ', '時間内に答えられませんでした。次の問題に進みます。', handleNextProblemAnimation);
                }
            }, 1000);
        }

        // タイマーをリセットする
        function resetTimer() {
            if (currentTimer) {
                clearInterval(currentTimer);
            }
            timerDisplay.textContent = '';
        }

        // タイトル画面に戻る
        function returnToTitleScreen() {
            gameScreen.style.display = 'none';
            titleScreen.style.display = 'flex';
            resetTimer();
            problemQueue = [];
        }

    </script>
</body>
</html>
